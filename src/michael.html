<head>
    <link rel="stylesheet" href="./icofont/icofont.min.css">
    <style>
        *{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body{
            background-color: #000044;
        }
        .button{
            
            background-color: white;
            
            border: none;
            font-size: 8vw;
            margin:5px;
            transition: all .25s ease-in-out;
        }

        .container{
            
            background-color: white;
            
            border: none;
            font-size: 8vw;
            margin:5px;
            transition: all .25s ease-in-out;
        }
        .container:focus{
            background-color: #ddddff;
        }

        .choice{
            width:90vw;
            height:20vh;
            border-radius: 6vw;
        }
        .choice-2col{
            width:43vw;
            height:20vh;
            border-radius: 6vw;
        }
        .number{
            border-radius: 20%;
            width: 20vw;
            height: 16vh;
        }
        .button:focus{
            background-color: #6666dd;
            color:white
        }
        .menu{
            transition: .5s all ease-in-out;
        }
        
    </style>
</head>
<body style="text-align: center;overflow:hidden">
    <div id="overlay" class="menu" style="position:absolute;width:100%;height:100%;top:0;bottom:0;right:0;left:0;background-color:rgba(0,0,0,0.5);z-index:2;display:none;opacity:0">
        <div style="background-color: #000044;padding:5vw;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:10vw;width:80vw">
            <span id="overlayMessage" style="color:white;font-size:5vh;margin:3vw;display:block;font-weight:600">Battery Already Signed Out...</span>
        </div>
    </div>
    <div id="menu_main" style="margin:10px;display:inline-block;" class="menu">
        <span style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600">Battery Manager</span>
        
        
        <div>
            <input type="button" value="Sign In" class="button choice-2col menuchange" style="display: inline-block;margin:1vw" data-menuto="signin" data-num="1">
            <input type="button" value="Sign Out" class="button choice-2col menuchange" style="display: inline-block;margin:1vw" data-menuto="signout" data-num="2">
        </div>
        
        
        <input type="button" value="Logs" class="button choice menuchange" style="display: block;margin:3vw" data-menuto="logs" data-num="3">
        <input type="button" value="Settings" class="button choice menuchange" style="display: block;margin:3vw" data-menuto="settings" data-num="4">
        <span style="color:white;font-size:2vh;margin:3vw;display:block;font-weight:600">Pick an Option 1-4</span>
    </div>
    <div id="menu_logs" style="margin:10px;display:none;" class="menu">
        <span style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600">Logs</span>
        <div style="display: block;margin:3vw;max-height:60vh;overflow-y:scroll" id="alllogs">
            
            
        </div>
        <input id="logscrollup" type="button" value="Up" class="button a number" style="display: none;" data-num="8">
        <input id="logscrolldown" type="button" value="Down" class="button a number" style="display: none;" data-num="2">
        <input type="button" value="Back to Main" class="button choice menuchange" style="display: block;margin:3vw;height:14vh" data-menuto="main" data-num="/">
        <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press 2/8 to scroll up/down</span>
        <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press SLASH to exit</span>
    </div>
    <div id="menu_signin" style="margin:10px;display:none;opacity:0%" class="menu">
        <span id="resultIn" style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600;opacity:0.6">Enter a Number</span>
        <br/>
        <input type="button" value="7" class="button a number" style="display: inline-block;" data-num="7">
            <input type="button" value="8" class="button a number" style="display: inline-block;" data-num="8">
            <input type="button" value="9" class="button a number" style="display: inline-block;" data-num="9">
            <br/>
            <input type="button" value="4" class="button a number" style="display: inline-block;" data-num="4">
            <input type="button" value="5" class="button a number" style="display: inline-block;" data-num="5">
            <input type="button" value="6" class="button a number" style="display: inline-block;" data-num="6">
            <br/>
            <input type="button" value="1" class="button a number" style="display: inline-block;" data-num="1">
            <input type="button" value="2" class="button a number" style="display: inline-block;" data-num="2">
            <input type="button" value="3" class="button a number" style="display: inline-block;" data-num="3">
            <br/>
            <button id="clearIn" class="button a number" style="display: inline-block;" data-num="/"><i class="icofont-close" style="font-size:7.5vh"></i></button>
            <input type="button" value="0" class="button a number" style="display: inline-block;" data-num="0">
            <button class="button number nextstep" style="display: inline-block;" data-num="Enter"><i class="icofont-check" style="font-size:7.5vh"></i></button>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Pick Numbers 0-9</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press SLASH to exit</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press ENTER to continue</span>
        

    </div>
    <div id="menu_signout" style="margin:10px;display:none;opacity:0%" class="menu">
        <div id="outA">
            <span id="resultOut" style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600;opacity:0.6">Enter a Number</span>
            <br/>
            <input type="button" value="7" class="button a number" style="display: inline-block;" data-num="7">
            <input type="button" value="8" class="button a number" style="display: inline-block;" data-num="8">
            <input type="button" value="9" class="button a number" style="display: inline-block;" data-num="9">
            <br/>
            <input type="button" value="4" class="button a number" style="display: inline-block;" data-num="4">
            <input type="button" value="5" class="button a number" style="display: inline-block;" data-num="5">
            <input type="button" value="6" class="button a number" style="display: inline-block;" data-num="6">
            <br/>
            <input type="button" value="1" class="button a number" style="display: inline-block;" data-num="1">
            <input type="button" value="2" class="button a number" style="display: inline-block;" data-num="2">
            <input type="button" value="3" class="button a number" style="display: inline-block;" data-num="3">
            <br/>
            <button id="clearOut" class="button a number" style="display: inline-block;" data-num="/"><i class="icofont-close" style="font-size:7.5vh"></i></button>
            <input type="button" value="0" class="button a number" style="display: inline-block;" data-num="0">
            <button class="button number nextstep" style="display: inline-block;" data-num="Enter" data-rest="outA"><i class="icofont-check" style="font-size:7.5vh"></i></button>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Pick Numbers 0-9</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press SLASH to exit</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press ENTER to continue</span>
        </div>
        <div id="outB" style="display:none">
            <div id="groupOut" class="optionitem" style="display: flex;justify-content:space-between">
                <span style="color:white;font-size:6vh;margin:7vw;display:inline-flex;">Group:</span>
                <input type="button" value="Comp" class="button choice settingschange" style="display: inline-block    ;margin:3vw;height:14vh;width:40vw;text-align:center;font-size:5vw" data-num="1" data-setting="subgroup" >
            </div>
            <div id="reasonOut" class="optionitem" style="display: flex;justify-content:space-between">
                <span style="color:white;font-size:6vh;margin:7vw;display:inline-flex;">Reason:</span>
                <input type="button" value="Comp" class="button choice settingschange" style="display: inline-block    ;margin:3vw;height:14vh;width:40vw;text-align:center;font-size:5vw" data-num="1" data-setting="reason" >
            </div>
            <br/>
            <button class="button choice nextstep" style="display: inline-block;width:50vw;height:10vh;font-size:6vw" data-num="Enter" data-rest="outB">Finish</button>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Toggle option using 1</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press SLASH to exit</span>
            <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press ENTER to continue</span>

        </div>
        

    </div>

    <div id="menu_settings" style="margin:10px;display:none;" class="menu">
        <span style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600">Settings</span>
        <div style="display: block;margin:3vw;max-height:60vh;overflow-y:scroll">
            <div class="optionitem" style="display: flex;justify-content:space-between">
                <span style="color:white;font-size:6vh;margin:7vw;display:inline-flex;">Mode:</span>
                <input type="button" value="Comp" class="button choice settingschange" style="display: inline-block    ;margin:3vw;height:14vh;width:40vw;text-align:center" data-num="1" data-setting="mode" >
            </div>
            <div class="optionitem" style="display: flex;justify-content:space-between">
                <span style="color:white;font-size:6vh;margin:7vw;display:inline-flex;">Isolate:</span>
                <input type="button" value="No" class="button choice settingschange" style="display: inline-block    ;margin:3vw;height:14vh;width:40vw;text-align:center" data-num="2" data-setting="isolate">
            </div>
        </div>
        <input type="button" value="Back to Main" class="button choice menuchange" style="display: block;margin:3vw;height:14vh" data-menuto="main" data-num="/">
        <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Pick an Option 1-2</span>
        <span style="color:white;font-size:2vh;margin:2vw;display:block;font-weight:600">Press SLASH to exit</span>
    </div>

    <div id="menu_notif" style="margin:10px;display:none;" class="menu">
        <span style="color:white;font-size:6vh;margin:3vw;display:block;font-weight:600" id="notifContent">Signed Out</span>
    </div>

    
    
    <script>

        var menu = "main";


        var enterText = ["Battery #", "RINT (w/o .)", "SOC"]

        var settings = {
            "mode": {
                "value": 0,
                "options": ["Comp", "No Comp"]
            },
            "isolate": {
                "value": 0,
                "options": ["No", "Yes"]
            },
            "subgroup": {
                "value": 0,
                "options": ["Electrical", "Design", "Fabrication", "Programming", "Strategy", "Other"]
            },
            "reason": {
                "value": 0,
                "options": ["Comp", "Practice", "Systems Check", "Other"]
            }
        }

        var currentlyWorking = {
            "doing" : undefined,
            "step" : 0
        }


        var formData = {
            batteryCode : undefined,
            subgroup : undefined,
            rint : undefined,
            soc : undefined,
            purpose : undefined
        };


        async function fetchAsync (url) {
            let response = await fetch(url, {headers:{'lrAction' : "YESSSSSS"}});
            let data = await response.json();
            return data;
          }

        document.getElementById('logscrolldown').addEventListener('click', function(){
            document.getElementById("alllogs").scrollBy(0,40);
        });
        document.getElementById('logscrollup').addEventListener('click', function(){
            document.getElementById("alllogs").scrollBy(0,-40);
        });


        Array.from(document.getElementsByClassName("settingschange")).forEach(function(element){
            element.addEventListener('click', function(evt){
                var setting = element.dataset.setting;
                settings[setting]["value"] += 1;
                if(settings[setting]["value"] >= settings[setting]["options"].length){
                    settings[setting]["value"] = 0;
                }
                evt.srcElement.value = settings[setting]["options"][settings[setting]["value"]];
            });
        });

        function showOverlay(content){
            document.getElementById('overlayMessage').innerHTML = content;
            document.getElementById('overlay').style.display = "inline";
            setTimeout(function(){
                document.getElementById("overlay").style.opacity = "1";
                setTimeout(function(){
                    document.getElementById("overlay").style.opacity = "0";
                    setTimeout(function(){
                        document.getElementById("overlay").style.display = "none";
                    },500);
                
                },3000);
            },30);
        }

        async function postData(url = '', data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
              method: 'POST', // *GET, POST, PUT, DELETE, etc.
              mode: 'cors', // no-cors, *cors, same-origin
              cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
              credentials: 'same-origin', // include, *same-origin, omit
              headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded',
              },
              redirect: 'follow', // manual, *follow, error
              referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
              body: JSON.stringify(data) // body data type must match "Content-Type" header
            });
            return response.json(); // parses JSON response into native JavaScript objects
          }

        function submitData(bNum, rintBefore, socBefore, rintAfter, socAfter, purpose, group){
            postData("/api/submitsign",{
                bNum: bNum,
                rintBefore: rintBefore,
                socBefore: socBefore,
                rintAfter: rintAfter,
                socAfter: socAfter,
                purpose: purpose,
                group: group
            
            }).then(data => {
                console.log(data);
            });
        }

        function showNotif(content){
            document.getElementById("notifContent").innerHTML = content;
            document.getElementById("menu_"+menu).style.opacity = "0";
            setTimeout(function(){
                document.getElementById("menu_"+menu).style.display = "none";
                menu = "notif";
                document.getElementById("menu_"+menu).style.display = "inline-block";
                setTimeout(function(){
                    document.getElementById("menu_"+menu).style.opacity = "1";
                },30);
                
            },500);
            setTimeout(function(){
                document.getElementById("menu_"+menu).style.opacity = "0";
                setTimeout(function(){
                    document.getElementById("menu_"+menu).style.display = "none";
                    menu = "main";
                    document.getElementById("menu_"+menu).style.display = "inline-block";
                    setTimeout(function(){
                        document.getElementById("menu_"+menu).style.opacity = "1";
                    },30);
                    
                },500);
            }, 3000);
        }

       document.addEventListener("keypress", function(e){
           e.preventDefault();
        var elem = document.getElementById("menu_" + menu);
        var elems = elem.getElementsByClassName("button")
        Array.from(elems).forEach(function(element){
            if(element.getAttribute("data-num") == e.key){
                element.focus();
                element.click();
            }
        });
       });
        var final = "";

        function setStepContent(){
            document.getElementById("resultIn").style.opacity = ".6";
            document.getElementById("resultOut").style.opacity = ".6";
            document.getElementById("resultIn").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
            document.getElementById("resultOut").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
            if(currentlyWorking["doing"] == "signin" && currentlyWorking["step"] > 3){
                console.log(formData);
                showNotif("Signed In");
                var batCode = parseFloat(formData["batteryCode"].substring(0,2) + "." + formData["batteryCode"].substring(2));
                submitData(batCode, null, null, parseFloat(formData["rint"]), parseInt(formData["soc"]), null, null);
                
            }else if(currentlyWorking["doing"] == "signout" && currentlyWorking["step"] > 5){
                formData["subgroup"] = settings["mode"]["value"] == 0 ? null : settings["subgroup"]["options"][settings["subgroup"]["value"]];
                formData["purpose"] = settings["mode"]["value"] == 0 ? settings["reason"]["options"][settings["reason"]["value"]] : null;

                console.log(formData)
                showNotif("Signed Out");
                var batCode = parseFloat(formData["batteryCode"].substring(0,2) + "." + formData["batteryCode"].substring(2));
                submitData(batCode, parseFloat(formData["rint"]), parseInt(formData["soc"]), null, null, formData["purpose"], formData["subgroup"]);
            }
            else if(currentlyWorking["doing"] == "signout" && currentlyWorking["step"] == 4){
                document.getElementById("outA").style.display = "none";

                if(settings["mode"]["value"] == 0){
                    document.getElementById("groupOut").style.display = "none";
                    document.getElementById("reasonOut").style.display = "inline";
                }else{
                    document.getElementById("groupOut").style.display = "inline";
                    document.getElementById("reasonOut").style.display = "none";
                }

                document.getElementById("outB").style.display = "inline-block";
            }
        }

        Array.from(document.getElementsByClassName("nextstep")).forEach(function(element){
            element.addEventListener('click', function(evt){
                
                try{
                    if(document.getElementById(evt.srcElement.dataset.rest).style.display == "none"){
                        console.log("WHAT")
                        return;
                    }
                }catch(e){

                }

                
                
                    var result = final;
                    var valid = true;
                    final = "";
                    

                    if(currentlyWorking["step"] == 1){
                        formData["batteryCode"] = result;
                        fetchAsync("/api/isBatteryOut/" + formData["batteryCode"]).then(function(data){
                            console.log(data);
                            if(currentlyWorking["doing"] == "signout" && data["signedOut"] == true){
                                showOverlay("Battery is already signed out");
                                currentlyWorking["step"] -= 1;
                                setStepContent();

                            }else if(currentlyWorking["doing"] == "signin" && data["signedOut"] == false){
                                showOverlay("Battery is already signed in");
                                currentlyWorking["step"] -= 1;
                                setStepContent();
                            }
                        });
                    }else if(currentlyWorking["step"] == 2){
                        formData["rint"] = "." + result;
                    }
                    else if(currentlyWorking["step"] == 3){
                        formData["soc"] = result + "%";
                    }
                    

                    

                    currentlyWorking["step"] += 1;
                    
                    setStepContent();
                
            });
        });
        Array.from(document.getElementsByClassName("a")).forEach(function(button){
            button.addEventListener("click", function(e){

                var toAdd = [];
                if(currentlyWorking["step"] == 1){
                    toAdd = ["",""];
                }else if(currentlyWorking["step"] == 2){
                    toAdd = [".",""]
                }else if(currentlyWorking["step"] == 3){
                    toAdd = ["","%"]
                }

                if(document.getElementById("resultIn").innerHTML == (currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A")){
                    final = "";
                }
                if(final.length >= 6){
                    final = "";
                }
                console.log(e.srcElement)
                final += button.value;

                document.getElementById("resultIn").style.opacity = "1";
                if(currentlyWorking["step"] == 1){
                    document.getElementById("resultIn").innerHTML = toAdd[0] + final.substring(0,2) +  "." + final.substring(2) + toAdd[1];
                    document.getElementById("resultOut").innerHTML = toAdd[0] + final.substring(0,2) +  "." + final.substring(2) + toAdd[1];
                }else{
                    document.getElementById("resultIn").innerHTML = toAdd[0] + final + toAdd[1];
                    document.getElementById("resultOut").innerHTML = toAdd[0] + final + toAdd[1];
                }
                
                document.getElementById("resultOut").style.opacity = "1";
                
            });
        });



        document.getElementById("clearIn").addEventListener("click", function(){
            if(final == ""){
                document.getElementById("menu_"+menu).style.opacity = "0";
                setTimeout(function(){
                    document.getElementById("menu_"+menu).style.display = "none";
                    menu = "main";
                    document.getElementById("menu_"+menu).style.display = "inline-block";
                    setTimeout(function(){
                        document.getElementById("menu_"+menu).style.opacity = "1";
                    },20);
                },500);
            }
            final = "";
            document.getElementById("resultIn").style.opacity = ".6";
            document.getElementById("resultOut").style.opacity = ".6";
            document.getElementById("resultIn").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
            document.getElementById("resultOut").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
        });
        document.getElementById("clearOut").addEventListener("click", function(){
            if(final == ""){
                document.getElementById("menu_"+menu).style.opacity = "0";
                setTimeout(function(){
                    document.getElementById("menu_"+menu).style.display = "none";
                    menu = "main";
                    document.getElementById("menu_"+menu).style.display = "inline-block";
                    setTimeout(function(){
                        document.getElementById("menu_"+menu).style.opacity = "1";
                    },30);
                },500);
            }
            final = "";
            document.getElementById("resultIn").style.opacity = ".6";
            document.getElementById("resultOut").style.opacity = ".6";
            document.getElementById("resultIn").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
            document.getElementById("resultOut").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
        });

        

        Array.from(document.getElementsByClassName("menuchange")).forEach(function(button){
            button.addEventListener("click", function(){

                if(button.dataset.menuto.includes("sign")){
                    document.getElementById("outA").style.display = "inline-block";
                    document.getElementById("outB").style.display = "none";
                    
                    currentlyWorking["doing"] = button.dataset.menuto;
                    currentlyWorking["step"] = 1;
                    document.getElementById("resultIn").style.opacity = ".6";
                    document.getElementById("resultOut").style.opacity = ".6";
                    document.getElementById("resultIn").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
                    document.getElementById("resultOut").innerHTML = currentlyWorking["step"] < 4 ? enterText[currentlyWorking["step"]-1] : "N/A";
                }

                document.getElementById("menu_"+menu).style.opacity = "0";
                setTimeout(function(){
                    document.getElementById("menu_"+menu).style.display = "none";
                    menu = button.dataset.menuto;
                    document.getElementById("menu_"+menu).style.display = "inline-block";
                    setTimeout(function(){
                        document.getElementById("menu_"+menu).style.opacity = "1";
                    },30);
                },500);
                
                
            });
        });

        setInterval(function(){
            fetchAsync("/api/allsignedout", {lrAction : "YES"}).then(function(data){
                var batteries = data;
                document.getElementById("alllogs").innerHTML = "";
                batteries.forEach(function(battery){
                    try{
                        var date = new Date(battery.timeOut);
                        var timeString = date.getHours() + ":" + date.getMinutes().toString().padStart(2, "0") + ":" + date.getSeconds().toString().padStart(2, "0");
                        document.getElementById("alllogs").innerHTML += `<div class="logitem" style="display:flex;justify-content:space-between">
                            <span style="color:white;font-size:4vh;margin:3vw;display:inline-flex;width:30%">${battery.batteryNumber}</span>
                            <span style="color:white;font-size:3vh;margin:3vw;display:inline-flex;width:30%">${timeString}</span>
                            <span style="color:white;font-size:4vh;margin:3vw;display:inline-flex;opacity:${battery.purpose == undefined ? 0.6 : 1}">${battery.purpose == undefined ? battery.subgroup : battery.purpose}</span>
                        </div>`;
                    }catch(e){
                        console.log(e)
                    }
                    
                });
            });
        }, 5000);

    </script>
</body>